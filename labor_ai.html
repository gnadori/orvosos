<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labor Diagnoszta AI - Javított</title>
    <style>
        /* STÍLUSOK */
        :root { --paper-bg: #fff; --ink: #000; --green: #8cc63f; --panel: #2c3e50; --red: #c0392b; --select: #fffde7; }
        body { background: #525659; font-family: 'Courier New', monospace; margin: 0; padding: 20px; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        
        /* Fő konténer */
        #game-container { display: none; gap: 20px; width: 100%; max-width: 1400px; height: 95vh; }
        
        /* Bal oldal: Lelet */
        .paper-sheet { background: var(--paper-bg); flex: 2; padding: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); overflow-y: auto; color: var(--ink); }
        .header-bar { border-top: 10px solid var(--green); margin-bottom: 20px; display: flex; justify-content: space-between; padding-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; border-bottom: 1px dashed #000; }
        td { padding: 4px; border-bottom: 1px solid transparent; cursor: pointer; }
        tr:hover { background: #f0f0f0; }
        tr.selected { background: var(--select); }
        tr.correct { color: green; font-weight: bold; }
        tr.missed { border: 1px solid red; }

        /* Jobb oldal: Kezelő */
        .control-panel { flex: 1; background: var(--panel); color: white; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; font-family: sans-serif; }
        .btn { background: var(--green); color: white; padding: 15px; border: none; cursor: pointer; margin-top: 10px; font-weight: bold; width: 100%; }
        .btn:hover { background: #7ab332; }
        textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 5px; }
        
        .option-btn { background: white; color: black; padding: 10px; margin-bottom: 5px; cursor: pointer; }
        .option-btn.correct { background: #27ae60; color: white; }
        .option-btn.wrong { background: #c0392b; color: white; }

        /* Start képernyő */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.95); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-family: sans-serif; }
        
        /* AI Feedback */
        #ai-feedback { background: rgba(0,0,0,0.3); padding: 10px; margin-top: 10px; display: none; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color: #8cc63f; font-size: 3rem;">LABOR DIAGNOSZTA</h1>
        <p>AI Támogatott Orvosi Szimuláció</p>
        <button class="btn" style="width: 200px;" onclick="startGame()">INDÍTÁS</button>
    </div>

    <div id="game-container">
        <div class="paper-sheet">
            <div class="header-bar">
                <div><strong>✚ DUNALAB</strong></div>
                <div>Sürgősségi Osztály</div>
            </div>
            <div style="margin-bottom: 20px;">
                <strong>Beteg:</strong> <span id="p-name">...</span><br>
                <strong>Panasz:</strong> <span id="p-symptoms">...</span>
            </div>
            <hr>
            <table>
                <thead><tr><th>Teszt</th><th>Eredmény</th><th>Egység</th><th>Ref.</th></tr></thead>
                <tbody id="lab-table-body"></tbody>
            </table>
        </div>

        <div class="control-panel">
            <div id="phase-title" style="color: #8cc63f; font-weight: bold; margin-bottom: 10px;">FÁZIS 1</div>
            <div id="instruction" style="background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 20px;">Jelöld ki a hibás értékeket!</div>
            
            <div id="options-container"></div>
            
            <div id="ai-container" style="display:none;">
                <textarea id="ai-input" placeholder="Írd le a diagnózist..."></textarea>
            </div>

            <button id="action-btn" class="btn" onclick="checkPhase1()">ELLENŐRZÉS</button>
            <div id="feedback" style="margin-top: 10px; font-weight: bold;"></div>
            <div id="ai-feedback"></div>
            
            <button id="next-btn" class="btn" style="background:#fff; color:#333; display:none;" onclick="nextCase()">KÖVETKEZŐ ➡️</button>
        </div>
    </div>

<script>
    // --- ADATOK ---
    const WORKER_URL = 'https://orvosolas.nadorig.workers.dev'; 

    const standardParams = [
        { name: "Nátrium", unit: "mmol/L", min: 135, max: 145 },
        { name: "Kálium", unit: "mmol/L", min: 3.5, "max": 5.1 },
        { name: "Glükóz", unit: "mmol/L", min: 3.9, "max": 6.0 },
        { name: "Kreatinin", unit: "μmol/L", min: 60, "max": 105 },
        { name: "Fehérvérsejt", unit: "G/L", min: 4.5, "max": 11.0 },
        { name: "Hemoglobin", unit: "g/L", min: 130, "max": 170 },
        { name: "CRP", unit: "mg/L", min: 0, "max": 5 }
    ];

    const cases = [
        {
            patient: { name: "Kovács Júlia", symptoms: "Fáradtság, sápadtság, hajhullás." },
            results: [
                { name: "Hemoglobin", value: 98, unit: "g/L", min: 120, max: 160, abnormal: true },
                { name: "Vas (Se-Fe)", value: 5.2, unit: "μmol/L", min: 10, max: 28, abnormal: true }
            ],
            correctSystem: "Vérképzés",
            correctDiag: "Vashiányos vérszegénység",
            explanation: "Az alacsony vas és hemoglobin vashiányra utal."
        },
        {
            patient: { name: "Nagy Péter", symptoms: "Láz, köhögés, mellkasi fájdalom." },
            results: [
                { name: "Fehérvérsejt", value: 19.5, unit: "G/L", min: 4.5, max: 11, abnormal: true },
                { name: "CRP", value: 120, unit: "mg/L", min: 0, max: 5, abnormal: true }
            ],
            correctSystem: "Immunrendszer",
            correctDiag: "Bakteriális fertőzés",
            explanation: "Magas gyulladásos értékek baktériumra utalnak."
        }
    ];

    let currentCaseIndex = 0;
    let score = 0;

    // --- INDÍTÁS ---
    function startGame() {
        console.log("Játék indítása...");
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        loadCase(0);
    }

    function loadCase(index) {
        currentCaseIndex = index;
        const c = cases[index];
        
        // UI Reset
        document.getElementById('p-name').innerText = c.patient.name;
        document.getElementById('p-symptoms').innerText = c.patient.symptoms;
        document.getElementById('feedback').innerText = "";
        document.getElementById('ai-feedback').style.display = "none";
        document.getElementById('next-btn').style.display = "none";
        
        setupPhase1(c);
    }

    // --- FÁZIS 1: ÉSZLELÉS ---
    function setupPhase1(c) {
        document.getElementById('phase-title').innerText = "FÁZIS 1: ÉSZLELÉS";
        document.getElementById('instruction').innerText = "Kattints a hibás értékekre!";
        document.getElementById('ai-container').style.display = "none";
        document.getElementById('options-container').style.display = "block";
        document.getElementById('options-container').innerHTML = ""; // Törlés
        
        const btn = document.getElementById('action-btn');
        btn.style.display = "block";
        btn.innerText = "ELLENŐRZÉS";
        btn.onclick = checkPhase1;

        const tbody = document.getElementById('lab-table-body');
        tbody.innerHTML = "";

        // Lista generálása
        let list = [...c.results];
        // Kitöltő adatok
        for(let i=0; i<5; i++) {
            let p = standardParams[i];
            // Csak ha még nincs ilyen paraméter
            if(!list.find(x => x.name === p.name)) {
                list.push({ name: p.name, value: (p.min+1).toFixed(1), unit: p.unit, min: p.min, max: p.max, abnormal: false });
            }
        }
        list.sort(() => Math.random() - 0.5);

        list.forEach((item) => {
            let tr = document.createElement('tr');
            tr.dataset.abnormal = item.abnormal;
            tr.onclick = function() { this.classList.toggle('selected'); };
            tr.innerHTML = `<td>${item.name}</td><td><b>${item.value}</b></td><td>${item.unit}</td><td>${item.min}-${item.max}</td>`;
            tbody.appendChild(tr);
        });
    }

    function checkPhase1() {
        let rows = document.querySelectorAll('tbody tr');
        let allGood = true;
        
        rows.forEach(tr => {
            let isAbnormal = tr.dataset.abnormal === "true";
            let isSelected = tr.classList.contains('selected');
            
            if(isAbnormal && isSelected) {
                tr.className = "correct"; // Helyes
            } else if(isAbnormal && !isSelected) {
                tr.className = "missed"; // Hiányzó
                allGood = false;
            } else if(!isAbnormal && isSelected) {
                tr.style.textDecoration = "line-through"; // Téves
                allGood = false;
            }
        });

        if(allGood) {
            document.getElementById('feedback').innerText = "✔ Minden hiba megvan!";
            document.getElementById('feedback').style.color = "#2ecc71";
            setTimeout(setupPhase2, 1000);
        } else {
            document.getElementById('feedback').innerText = "⚠️ Javítsd a hibákat!";
            document.getElementById('feedback').style.color = "#e74c3c";
        }
    }

    // --- FÁZIS 2: RENDSZER ---
    function setupPhase2() {
        document.getElementById('phase-title').innerText = "FÁZIS 2: RENDSZER";
        document.getElementById('instruction').innerText = "Melyik rendszer érintett?";
        document.getElementById('action-btn').style.display = "none";
        document.getElementById('feedback').innerText = "";
        
        let systems = ["Vérképzés", "Immunrendszer", "Vese", "Máj", "Epe"];
        let correct = cases[currentCaseIndex].correctSystem;
        let container = document.getElementById('options-container');
        container.innerHTML = "";

        systems.sort(() => Math.random() - 0.5).slice(0,4).forEach(sys => {
            if(!systems.includes(correct)) systems[0] = correct; // Biztos legyen benne a jó
        });
        
        // Ha véletlen kivettük a jót, tegyük vissza (egyszerűsített logika)
        let opts = [correct, "Vese", "Máj", "Szív"].sort(() => Math.random() - 0.5);

        opts.forEach(sys => {
            let div = document.createElement('div');
            div.className = "option-btn";
            div.innerText = sys;
            div.onclick = function() {
                if(sys === correct) {
                    this.classList.add('correct');
                    setTimeout(setupPhase3, 800);
                } else {
                    this.classList.add('wrong');
                }
            };
            container.appendChild(div);
        });
    }

    // --- FÁZIS 3: AI DIAGNÓZIS ---
    function setupPhase3() {
        document.getElementById('phase-title').innerText = "FÁZIS 3: AI DIAGNÓZIS";
        document.getElementById('instruction').innerText = "Írd be a diagnózist saját szavaiddal!";
        document.getElementById('options-container').style.display = "none";
        document.getElementById('ai-container').style.display = "block";
        
        let btn = document.getElementById('action-btn');
        btn.style.display = "block";
        btn.innerText = "AI KIÉRTÉKELÉS";
        btn.onclick = callAI;
    }

    async function callAI() {
        let text = document.getElementById('ai-input').value;
        if(text.length < 3) { alert("Írj valamit!"); return; }
        
        let btn = document.getElementById('action-btn');
        btn.innerText = "Kérlek várj...";
        btn.disabled = true;

        let currentCase = cases[currentCaseIndex];
        
        // Itt hívjuk a valódi AI-t
        try {
            let criteria = {};
            criteria[`A helyes diagnózis: ${currentCase.correctDiag}`] = 50;

            const response = await fetch(WORKER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ textToEvaluate: text, criteria: criteria })
            });
            
            if(!response.ok) throw new Error("Hiba a hálózatban");
            
            const data = await response.json();
            
            let fbBox = document.getElementById('ai-feedback');
            fbBox.style.display = "block";
            fbBox.innerHTML = `
                <div style="font-size:1.2em; font-weight:bold;">AI Pontszám: ${data.score}/50</div>
                <div style="font-style:italic;">"${data.explanation}"</div>
            `;
            
            document.getElementById('next-btn').style.display = "block";
            btn.style.display = "none";

        } catch(e) {
            console.error(e);
            alert("Nem sikerült elérni az AI szervert. (CORS vagy Hálózati hiba)");
            btn.disabled = false;
            btn.innerText = "ÚJRA";
        }
    }

    function nextCase() {
        currentCaseIndex++;
        if(currentCaseIndex >= cases.length) {
            alert("Vége a játéknak! Szép munka!");
            location.reload();
        } else {
            loadCase(currentCaseIndex);
        }
    }

</script>
</body>
</html>
