export default {
  async fetch(request, env) {
    // 1. CORS Fejlécek
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    };

    if (request.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }

    if (request.method !== "POST") {
      return new Response("Csak POST kérés engedélyezett", { status: 405, headers: corsHeaders });
    }

    try {
      const { textToEvaluate, criteria } = await request.json();
      
      const systemPrompt = `
        Szerep: Orvostanhallgatókat vizsgáztató professzor.
        Feladat: Értékeld a diagnózist.
        
        Tények (Helyes megoldás):
        ${JSON.stringify(criteria)}
        
        Hallgató válasza: "${textToEvaluate}"
        
        Válaszformátum (csak tiszta JSON):
        {
          "score": (Szám 0-50 között),
          "explanation": "Rövid, tanító jellegű szöveges értékelés magyarul."
        }
      `;

      // 2. Google Gemini API hívás BIZTONSÁGI BEÁLLÍTÁSOKKAL
      const geminiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${env.GEMINI_API_KEY}`;
      
      const aiResponse = await fetch(geminiUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: systemPrompt }] }],
          // FONTOS: Kikapcsoljuk a blokkolást, hogy az orvosi szövegek átmenjenek
          safety_settings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
          ],
          generation_config: {
            temperature: 0.7,
            max_output_tokens: 500
            // response_mime_type eltávolítva, mert a v1 API nem támogatja
          }
        })
      });

      // 3. Hibakezelés: Ha a Google nem 200 OK-t küld
      if (!aiResponse.ok) {
        const errorText = await aiResponse.text();
        throw new Error(`Google API Hiba (${aiResponse.status}): ${errorText}`);
      }

      const aiData = await aiResponse.json();
      
      // Ellenőrizzük, hogy van-e jelölt válasz
      if (!aiData.candidates || aiData.candidates.length === 0) {
        // Ha a biztonsági szűrő mégis megfogta volna (finishReason: SAFETY)
        if (aiData.promptFeedback && aiData.promptFeedback.blockReason) {
           throw new Error(`Biztonsági blokkolás: ${aiData.promptFeedback.blockReason}`);
        }
        throw new Error("Az AI üres választ küldött.");
      }

      const rawText = aiData.candidates[0].content.parts[0].text;
      // Robusztus JSON kinyerés: megkeressük az első { és utolsó } karaktert
      const firstBrace = rawText.indexOf('{');
      const lastBrace = rawText.lastIndexOf('}');
      let cleanJson = rawText;
      
      if (firstBrace !== -1 && lastBrace !== -1) {
        cleanJson = rawText.substring(firstBrace, lastBrace + 1);
      } else {
        // Ha nincs { }, akkor megpróbáljuk a markdown-t leszedni, hátha
        cleanJson = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
      }
      
      return new Response(cleanJson, {
        headers: { ...corsHeaders, "Content-Type": "application/json" }
      });

    } catch (error) {
      // Részletes hiba visszaküldése a felhasználónak
      return new Response(JSON.stringify({ 
        score: 0, 
        explanation: "Technikai hiba: " + error.message 
      }), {
        status: 200, 
        headers: { ...corsHeaders, "Content-Type": "application/json" }
      });
    }
  }
};